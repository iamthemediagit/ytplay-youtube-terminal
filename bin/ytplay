#!/bin/bash
# ytplay - Recherche YouTube interactive avec s√©lection fzf + lecture mpv
# Usage: ytplay "search query"

set -e

QUERY="${1:-documentaire in√©dit}"
MAX_RESULTS="${2:-20}"

# V√©rifier les d√©pendances
for cmd in yt-dlp fzf jq mpv; do
    if ! command -v $cmd &> /dev/null; then
        echo "‚ùå Erreur: $cmd n'est pas install√©"
        exit 1
    fi
done

echo "üîç Recherche: $QUERY (${MAX_RESULTS} r√©sultats)..."
echo ""

# Extraire les r√©sultats YouTube en JSON
RESULTS=$(yt-dlp --dump-json --flat-playlist --skip-download "ytsearch${MAX_RESULTS}:${QUERY}" 2>/dev/null)

if [ -z "$RESULTS" ]; then
    echo "‚ùå Aucun r√©sultat trouv√©"
    exit 1
fi

# Formater pour fzf: "Titre | Dur√©e | Auteur | Date | ID"
FORMATTED=$(echo "$RESULTS" | jq -r '
    .title + " | " + 
    (if .duration then (.duration | tostring + "s") else "N/A" end) + " | " + 
    .uploader + " | " + 
    (if .upload_date then (.upload_date | tostring) else "N/A" end) + " | " + 
    .id
')

# S√©lection interactive avec fzf (multi-s√©lection avec Tab)
SELECTED=$(echo "$FORMATTED" | fzf \
    --multi \
    --prompt="S√©lectionner vid√©o(s) ‚ñ∂ " \
    --height=100% \
    --layout=reverse \
    --info=inline \
    --border \
    --preview-window=up:3:wrap \
    --preview='echo "üì∫ {1..4}"' \
    --bind='ctrl-a:select-all,ctrl-d:deselect-all' \
    --header='‚Üë‚Üì: naviguer | Tab: s√©lectionner plusieurs | Enter: confirmer | Esc: quitter')

if [ -z "$SELECTED" ]; then
    echo "‚ùå Aucune s√©lection"
    exit 0
fi

# Compter le nombre de s√©lections
NUM_SELECTED=$(echo "$SELECTED" | wc -l | tr -d ' ')

# Extraire les URLs
VIDEO_URLS=()
while IFS= read -r line; do
    VIDEO_ID=$(echo "$line" | awk -F' \\| ' '{print $NF}')
    VIDEO_URLS+=("https://www.youtube.com/watch?v=${VIDEO_ID}")
done <<< "$SELECTED"

echo ""
if [ "$NUM_SELECTED" -eq 1 ]; then
    VIDEO_TITLE=$(echo "$SELECTED" | awk -F' \\| ' '{print $1}')
    echo "‚ñ∂Ô∏è  Lecture: $VIDEO_TITLE"
else
    echo "‚ñ∂Ô∏è  Lecture de $NUM_SELECTED vid√©os (playlist)"
    echo "   Utilisez < et > dans mpv pour naviguer"
fi
echo ""

# Demander audio ou vid√©o
echo "Mode de lecture:"
echo "  [1] Audio seul (d√©faut)"
echo "  [2] Vid√©o"
echo -n "Choix (1/2): "
read -t 5 MODE || MODE="1"
echo ""

# Afficher les raccourcis clavier
echo "‚å®Ô∏è  Raccourcis mpv:"
echo "   <  >     : Vid√©o pr√©c√©dente/suivante"
echo "   ‚Üê  ‚Üí     : Reculer/Avancer 5s"
echo "   ‚Üë  ‚Üì     : Volume +/-"
echo "   Space    : Pause/Play"
echo "   q        : Quitter"
echo ""

case $MODE in
    2)
        echo "üìπ Lecture vid√©o..."
        mpv "${VIDEO_URLS[@]}"
        ;;
    *)
        echo "üéß Lecture audio..."
        mpv --no-video "${VIDEO_URLS[@]}"
        ;;
esac
